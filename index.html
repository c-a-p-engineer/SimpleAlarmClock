<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>マルチアラーム - 音声合成＆通知対応</title>
  <!-- Bootstrap 5.3.0 CDN -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-ENjdO4Dr2bkBIFxQpeoVMQcJ6Q1pb9K/7rLq1YFfFQh2eS5BnvWic8M0B4d7xB8+" crossorigin="anonymous">
  <style>
    body {
      background-color: #1f1f1f;
      color: #e0e0e0;
    }
    .container {
      margin-top: 2rem;
      max-width: 800px;
    }
    .active-alarm {
      background-color: #b71c1c;
      padding: 1rem;
      border-radius: 0.3rem;
      text-align: center;
      margin-bottom: 1rem;
    }
    .table thead th {
      background-color: #333;
      color: #e0e0e0;
    }
    .table tbody tr.active {
      background-color: #b71c1c;
    }
    .table tbody tr.upcoming:hover {
      background-color: #2a2a2a;
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- ヘッダー -->
    <header class="mb-4">
      <h1 class="text-center">マルチアラーム</h1>
    </header>

    <!-- アラーム設定入力エリア -->
    <div class="card mb-4">
      <div class="card-header">アラーム追加</div>
      <div class="card-body">
        <div class="mb-3">
          <label for="alarmTime" class="form-label">時刻入力</label>
          <input type="time" id="alarmTime" class="form-control">
        </div>
        <div class="mb-3">
          <label for="alarmMessage" class="form-label">メッセージ</label>
          <input type="text" id="alarmMessage" class="form-control" placeholder="例: 時間になりました。">
        </div>
        <fieldset class="mb-3">
          <legend class="col-form-label">アラームタイプ</legend>
          <div class="form-check form-check-inline">
            <input class="form-check-input" type="radio" name="alarmType" id="dailyRadio" value="daily" checked>
            <label class="form-check-label" for="dailyRadio">毎日</label>
          </div>
          <div class="form-check form-check-inline">
            <input class="form-check-input" type="radio" name="alarmType" id="weeklyRadio" value="weekly">
            <label class="form-check-label" for="weeklyRadio">曜日指定</label>
          </div>
          <div class="form-check form-check-inline">
            <input class="form-check-input" type="radio" name="alarmType" id="onceRadio" value="once">
            <label class="form-check-label" for="onceRadio">一回限り</label>
          </div>
        </fieldset>
        <!-- 曜日指定オプション -->
        <div id="weeklyOptions" class="mb-3" style="display:none;">
          <label class="form-label">曜日を選択</label><br>
          <div class="form-check form-check-inline">
            <input class="form-check-input" type="checkbox" id="day0" value="0">
            <label class="form-check-label" for="day0">日</label>
          </div>
          <div class="form-check form-check-inline">
            <input class="form-check-input" type="checkbox" id="day1" value="1">
            <label class="form-check-label" for="day1">月</label>
          </div>
          <div class="form-check form-check-inline">
            <input class="form-check-input" type="checkbox" id="day2" value="2">
            <label class="form-check-label" for="day2">火</label>
          </div>
          <div class="form-check form-check-inline">
            <input class="form-check-input" type="checkbox" id="day3" value="3">
            <label class="form-check-label" for="day3">水</label>
          </div>
          <div class="form-check form-check-inline">
            <input class="form-check-input" type="checkbox" id="day4" value="4">
            <label class="form-check-label" for="day4">木</label>
          </div>
          <div class="form-check form-check-inline">
            <input class="form-check-input" type="checkbox" id="day5" value="5">
            <label class="form-check-label" for="day5">金</label>
          </div>
          <div class="form-check form-check-inline">
            <input class="form-check-input" type="checkbox" id="day6" value="6">
            <label class="form-check-label" for="day6">土</label>
          </div>
        </div>
        <!-- 一回限りオプション -->
        <div id="onceOptions" class="mb-3" style="display:none;">
          <label for="onceDate" class="form-label">日付選択</label>
          <input type="date" id="onceDate" class="form-control">
        </div>
        <button class="btn btn-success" onclick="addAlarm()">アラーム追加</button>
      </div>
    </div>

    <!-- アラーム発動中表示 -->
    <div id="activeAlarmSection" class="active-alarm" style="display:none;">
      <h4>アラーム発動中！</h4>
      <button class="btn btn-primary" onclick="stopAlarm()">停止</button>
    </div>

    <!-- 設定済みアラーム一覧 -->
    <div class="card">
      <div class="card-header">設定済みアラーム一覧</div>
      <div class="card-body p-0">
        <table class="table table-dark table-striped mb-0">
          <thead>
            <tr>
              <th>#</th>
              <th>時刻</th>
              <th>タイプ</th>
              <th>詳細</th>
              <th>メッセージ</th>
              <th>次回実行</th>
              <th>有効</th>
              <th>操作</th>
            </tr>
          </thead>
          <tbody id="alarmsTable"></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Bootstrap 5 JavaScript (Popper.js 同梱) -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js" integrity="sha384-q2ky+TLUX6eFTD9eAK/pE6voJz/y7BwH5XGd2UVISalSmLrXr2kkdQHyg2HykGmZ" crossorigin="anonymous"></script>
  
  <script>
    /*******************
     * グローバル変数
     *******************/
    let alarms = [];            // アラーム設定リスト
    let alarmIdCounter = 0;     
    let isAlarmRinging = false; // アラーム発動中フラグ

    const STORAGE_KEY = 'alarms';

    /*******************
     * 通知許可リクエスト
     *******************/
    if ("Notification" in window && Notification.permission !== "granted") {
      Notification.requestPermission();
    }
    
    /*******************
     * localStorage 保存／読み込み
     *******************/
    function saveAlarms() {
      const alarmsToSave = alarms.map(alarm => ({
        id: alarm.id,
        mode: alarm.mode,
        time: alarm.time,
        days: alarm.days,
        date: alarm.date,
        message: alarm.message,
        enabled: alarm.enabled
      }));
      localStorage.setItem(STORAGE_KEY, JSON.stringify(alarmsToSave));
    }
    function loadAlarms() {
      const data = localStorage.getItem(STORAGE_KEY);
      if (data) {
        try {
          const storedAlarms = JSON.parse(data);
          storedAlarms.forEach(alarmData => {
            const alarm = {
              id: alarmData.id,
              mode: alarmData.mode,
              time: alarmData.time,
              days: alarmData.days || [],
              date: alarmData.date || null,
              message: alarmData.message,
              enabled: alarmData.enabled,
              active: false
            };
            alarms.push(alarm);
            if (alarm.id >= alarmIdCounter) {
              alarmIdCounter = alarm.id + 1;
            }
            if (alarm.enabled) {
              scheduleAlarm(alarm);
            }
          });
          updateAlarmsTable();
        } catch(e) {
          console.error("保存データの読み込みに失敗:", e);
        }
      }
    }
    
    /*******************
     * ユーザー入力表示の制御
     *******************/
    document.querySelectorAll('input[name="alarmType"]').forEach(radio => {
      radio.addEventListener('change', function() {
        const type = this.value;
        document.getElementById('weeklyOptions').style.display = (type === 'weekly') ? 'block' : 'none';
        document.getElementById('onceOptions').style.display = (type === 'once') ? 'block' : 'none';
      });
    });
    
    /*******************
     * アラーム追加・スケジュール
     *******************/
    function addAlarm() {
      const timeInput = document.getElementById('alarmTime').value;
      const messageInput = document.getElementById('alarmMessage').value.trim();
      if (!timeInput) {
        alert("時刻を入力してください。");
        return;
      }
      if (!messageInput) {
        alert("メッセージを入力してください。");
        return;
      }
      const alarmType = document.querySelector('input[name="alarmType"]:checked').value;
      let alarm = {
        id: alarmIdCounter,
        mode: alarmType,
        time: timeInput,
        days: [],
        date: null,
        message: messageInput,
        enabled: true,
        active: false
      };
      if (alarmType === 'weekly') {
        const checkedDays = Array.from(document.querySelectorAll('#weeklyOptions input[type="checkbox"]:checked'))
                              .map(cb => parseInt(cb.value, 10));
        if (checkedDays.length === 0) {
          alert("曜日指定の場合、少なくとも1つの曜日を選択してください。");
          return;
        }
        alarm.days = checkedDays;
      } else if (alarmType === 'once') {
        const onceDate = document.getElementById('onceDate').value;
        if (!onceDate) {
          alert("一回限りの場合、日付を選択してください。");
          return;
        }
        alarm.date = onceDate;
      }
      alarms.push(alarm);
      alarmIdCounter++;
      if (alarm.enabled) scheduleAlarm(alarm);
      updateAlarmsTable();
      saveAlarms();
      alert("アラームを追加しました。");
    }
    
    /**
     * 曜日数値（0～6）を日本語の曜日に変換する
     */
    function convertDaysToJapanese(days) {
      const dayNames = ["日", "月", "火", "水", "木", "金", "土"];
      return days.map(d => dayNames[d] || d).join("、");
    }
    
    /**
     * 次回実行時刻を計算
     */
    function computeNextAlarmTime(alarm) {
      const now = new Date();
      const [hour, minute] = alarm.time.split(":").map(Number);
      let nextTime = null;
      if (alarm.mode === 'daily') {
        nextTime = new Date(now.getFullYear(), now.getMonth(), now.getDate(), hour, minute, 0);
        if (nextTime <= now) nextTime.setDate(nextTime.getDate() + 1);
      } else if (alarm.mode === 'weekly') {
        let daysAhead = null;
        for (let i = 0; i < 7; i++) {
          let potential = new Date(now);
          potential.setDate(now.getDate() + i);
          if (alarm.days.includes(potential.getDay())) {
            if (i === 0) {
              let currentMinutes = now.getHours() * 60 + now.getMinutes();
              let alarmMinutes = hour * 60 + minute;
              if (alarmMinutes > currentMinutes) {
                daysAhead = i;
                break;
              }
            } else {
              daysAhead = i;
              break;
            }
          }
        }
        if (daysAhead === null) daysAhead = 7;
        nextTime = new Date(now);
        nextTime.setDate(now.getDate() + daysAhead);
        nextTime.setHours(hour, minute, 0, 0);
      } else if (alarm.mode === 'once') {
        const [year, month, day] = alarm.date.split("-").map(Number);
        nextTime = new Date(year, month - 1, day, hour, minute, 0);
        if (nextTime <= now) return null;
      }
      return nextTime;
    }
    
    /**
     * 指定アラームのタイマーをスケジュール
     */
    function scheduleAlarm(alarm) {
      if (!alarm.enabled) return;
      const nextTime = computeNextAlarmTime(alarm);
      if (!nextTime) return;
      alarm.nextTime = nextTime;
      const now = new Date();
      const timeout = nextTime.getTime() - now.getTime();
      alarm.timerId = setTimeout(() => {
        triggerAlarm(alarm.id);
        if (alarm.mode === 'daily' || alarm.mode === 'weekly') {
          scheduleAlarm(alarm);
          saveAlarms();
          updateAlarmsTable();
        } else if (alarm.mode === 'once') {
          removeAlarm(alarm.id);
          saveAlarms();
          updateAlarmsTable();
        }
      }, timeout);
    }
    
    /*******************
     * アラーム一覧表示・削除・有効／無効切替
     *******************/
    function updateAlarmsTable() {
      const tbody = document.getElementById("alarmsTable").getElementsByTagName("tbody")[0];
      tbody.innerHTML = "";
      // 次回実行時刻順にソート（nextTime がないものは後ろへ）
      const sortedAlarms = alarms.slice().sort((a, b) => {
        const aTime = a.nextTime ? new Date(a.nextTime).getTime() : Infinity;
        const bTime = b.nextTime ? new Date(b.nextTime).getTime() : Infinity;
        return aTime - bTime;
      });
      sortedAlarms.forEach((alarm, index) => {
        const row = tbody.insertRow();
        row.className = alarm.active ? "active" : "upcoming";
        row.insertCell(0).innerText = index + 1;
        row.insertCell(1).innerText = alarm.time;
        row.insertCell(2).innerText = 
          alarm.mode === "daily" ? "毎日" :
          alarm.mode === "weekly" ? "曜日指定" : "一回限り";
        row.insertCell(3).innerText = 
          alarm.mode === "weekly" ? convertDaysToJapanese(alarm.days) :
          (alarm.mode === "once" ? alarm.date : "-");
        row.insertCell(4).innerText = alarm.message;
        row.insertCell(5).innerText = alarm.nextTime ? alarm.nextTime.toLocaleString() : "-";
        const enableCell = row.insertCell(6);
        enableCell.innerHTML = `<input type="checkbox" id="toggle_${alarm.id}" onchange="toggleAlarmState(${alarm.id})" ${alarm.enabled ? "checked" : ""}>`;
        row.insertCell(7).innerHTML = `<button class="btn btn-sm btn-danger" onclick="removeAlarm(${alarm.id})">削除</button>`;
      });
    }
    
    function toggleAlarmState(id) {
      const alarm = alarms.find(a => a.id === id);
      if (!alarm) return;
      const checkbox = document.getElementById("toggle_" + id);
      if (checkbox.checked) {
        alarm.enabled = true;
        scheduleAlarm(alarm);
      } else {
        alarm.enabled = false;
        if (alarm.timerId) {
          clearTimeout(alarm.timerId);
          alarm.timerId = null;
        }
      }
      saveAlarms();
      updateAlarmsTable();
    }
    
    function removeAlarm(id) {
      const idx = alarms.findIndex(a => a.id === id);
      if (idx !== -1) {
        if (alarms[idx].timerId) clearTimeout(alarms[idx].timerId);
        alarms.splice(idx, 1);
        updateAlarmsTable();
        saveAlarms();
      }
    }
    
    /*******************
     * 音声合成によるアラーム発動処理（繰り返し実行）
     *******************/
    function repeatSpeakAlarm(message) {
      if (!isAlarmRinging) return;
      let utterance = new SpeechSynthesisUtterance(message);
      utterance.lang = "ja-JP";
      utterance.onend = function() {
        if (isAlarmRinging) {
          repeatSpeakAlarm(message);
        }
      };
      speechSynthesis.speak(utterance);
    }
    
    function triggerAlarm(id) {
      const alarm = alarms.find(a => a.id === id);
      if (!alarm || !alarm.enabled) return;
      if (!isAlarmRinging) {
        isAlarmRinging = true;
        document.getElementById("activeAlarmSection").style.display = "block";
        // デスクトップ通知（許可されていれば）
        if ("Notification" in window && Notification.permission === "granted") {
          new Notification("アラーム発動", { body: alarm.message });
        }
        // 繰り返し音声合成実行
        repeatSpeakAlarm(alarm.message);
      }
      alarm.active = true;
      updateAlarmsTable();
    }
    
    function stopAlarm() {
      if (isAlarmRinging) {
        isAlarmRinging = false;
        speechSynthesis.cancel();
        document.getElementById("activeAlarmSection").style.display = "none";
        alarms.forEach(a => { if (a.active) a.active = false; });
        updateAlarmsTable();
      }
    }
    
    /*******************
     * 初回読み込み時処理
     *******************/
    window.addEventListener("load", () => {
      loadAlarms();
    });
  </script>
</body>
</html>
