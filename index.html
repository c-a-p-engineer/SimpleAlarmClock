<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <!-- レスポンシブ対応 -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>マルチアラーム - レスポンシブ対応</title>
  <style>
    /* リセット・基本設定 */
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      background-color: #1f1f1f;
      color: #e0e0e0;
      font-family: Arial, sans-serif;
      line-height: 1.4;
      padding: 1rem;
    }
    .container {
      max-width: 800px;
      margin: 0 auto;
      padding: 0 1rem;
    }
    header { text-align: center; margin-bottom: 1.5rem; }
    h1 { font-size: 2.5rem; margin-bottom: 0.5rem; }
    
    /* カード風のボックス（フォーム／一覧） */
    .card {
      background-color: #2b2b2b;
      border-radius: 8px;
      padding: 1rem;
      margin-bottom: 1.5rem;
    }
    .card-header {
      font-size: 1.5rem;
      margin-bottom: 1rem;
      border-bottom: 1px solid #444;
      padding-bottom: 0.5rem;
    }
    .card-body { margin-bottom: 1rem; }
    
    /* フォーム */
    .form-group { margin-bottom: 1rem; }
    label { display: block; margin-bottom: 0.3rem; }
    input[type="time"],
    input[type="date"],
    input[type="text"] {
      width: 100%;
      padding: 0.5rem;
      border: none;
      border-radius: 4px;
    }
    .radio-group { margin-bottom: 1rem; }
    .radio-group label {
      display: inline-block;
      margin-right: 1rem;
      cursor: pointer;
    }
    .option-inline label {
      display: inline-block;
      margin-right: 1rem;
      cursor: pointer;
    }
    .btn {
      background-color: #4CAF50;
      color: #fff;
      border: none;
      padding: 0.5rem 1rem;
      border-radius: 4px;
      cursor: pointer;
    }
    .btn:hover { background-color: #45a049; }
    .btn-danger { background-color: #e53935; }
    .btn-danger:hover { background-color: #d32f2f; }
    .btn-primary { background-color: #0d47a1; }
    .btn-primary:hover { background-color: #1565c0; }
    
    /* アクティブアラーム表示 */
    .active-alarm {
      background-color: #b71c1c;
      padding: 1rem;
      border-radius: 8px;
      text-align: center;
      margin-bottom: 1.5rem;
    }
    
    /* テーブル */
    table { width: 100%; border-collapse: collapse; margin-bottom: 1.5rem; }
    table, th, td { border: 1px solid #444; }
    th, td { padding: 0.5rem; text-align: center; }
    th { background-color: #333; }
    tr.active { background-color: #b71c1c; }
    tr.upcoming:hover { background-color: #2a2a2a; }
    
    /* レスポンシブ対応 */
    @media (max-width: 600px) {
      h1 { font-size: 2rem; }
      .card-header { font-size: 1.3rem; }
      th, td { font-size: 0.8rem; }
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>マルチアラーム</h1>
    </header>
    
    <!-- アラーム設定入力エリア -->
    <div class="card">
      <div class="card-header">アラーム追加</div>
      <div class="card-body">
        <div class="form-group">
          <label for="alarmTime">時刻入力</label>
          <input type="time" id="alarmTime">
        </div>
        <div class="form-group">
          <label for="alarmMessage">メッセージ</label>
          <input type="text" id="alarmMessage" placeholder="例: 時間になりました。">
        </div>
        <div class="radio-group">
          <label><input type="radio" name="alarmType" value="daily" checked> 毎日</label>
          <label><input type="radio" name="alarmType" value="weekly"> 曜日指定</label>
          <label><input type="radio" name="alarmType" value="once"> 一回限り</label>
        </div>
        <!-- 曜日指定オプション -->
        <div class="form-group" id="weeklyOptions" style="display:none;">
          <label>曜日を選択</label>
          <div class="option-inline">
            <label><input type="checkbox" value="0"> 日</label>
            <label><input type="checkbox" value="1"> 月</label>
            <label><input type="checkbox" value="2"> 火</label>
            <label><input type="checkbox" value="3"> 水</label>
            <label><input type="checkbox" value="4"> 木</label>
            <label><input type="checkbox" value="5"> 金</label>
            <label><input type="checkbox" value="6"> 土</label>
          </div>
        </div>
        <!-- 一回限りオプション -->
        <div class="form-group" id="onceOptions" style="display:none;">
          <label for="onceDate">日付選択</label>
          <input type="date" id="onceDate">
        </div>
        <button class="btn" onclick="addAlarm()">アラーム追加</button>
      </div>
    </div>
    
    <!-- アラーム発動中表示 -->
    <div id="activeAlarmSection" class="active-alarm" style="display:none;">
      <h4>アラーム発動中！</h4>
      <button class="btn btn-primary" onclick="stopAlarm()">停止</button>
    </div>
    
    <!-- 設定済みアラーム一覧 -->
    <div class="card">
      <div class="card-header">設定済みアラーム一覧</div>
      <div class="card-body">
        <table>
          <thead>
            <tr>
              <th>#</th>
              <th>時刻</th>
              <th>タイプ</th>
              <th>詳細</th>
              <th>メッセージ</th>
              <th>次回実行</th>
              <th>有効</th>
              <th>操作</th>
            </tr>
          </thead>
          <tbody id="alarmsTable"></tbody>
        </table>
      </div>
    </div>
    
  </div>
  
  <script>
    /*******************
     * グローバル変数
     *******************/
    let alarms = [];
    let alarmIdCounter = 0;
    let isAlarmRinging = false;
    const STORAGE_KEY = 'alarms';

    // 通知許可
    if ("Notification" in window && Notification.permission !== "granted") {
      Notification.requestPermission();
    }
    
    /*******************
     * localStorage 保存／読み込み
     *******************/
    function saveAlarms() {
      const alarmsToSave = alarms.map(alarm => ({
        id: alarm.id,
        mode: alarm.mode,
        time: alarm.time,
        days: alarm.days,
        date: alarm.date,
        message: alarm.message,
        enabled: alarm.enabled
      }));
      localStorage.setItem(STORAGE_KEY, JSON.stringify(alarmsToSave));
    }
    
    function loadAlarms() {
      const data = localStorage.getItem(STORAGE_KEY);
      if (data) {
        try {
          const storedAlarms = JSON.parse(data);
          storedAlarms.forEach(alarmData => {
            const alarm = {
              id: alarmData.id,
              mode: alarmData.mode,
              time: alarmData.time,
              days: alarmData.days || [],
              date: alarmData.date || null,
              message: alarmData.message,
              enabled: alarmData.enabled,
              active: false
            };
            alarms.push(alarm);
            if (alarm.id >= alarmIdCounter) { alarmIdCounter = alarm.id + 1; }
            if (alarm.enabled) { scheduleAlarm(alarm); }
          });
          updateAlarmsTable();
        } catch(e) {
          console.error("保存データの読み込みに失敗:", e);
        }
      }
    }
    
    /*******************
     * ユーザー入力表示制御
     *******************/
    document.querySelectorAll('input[name="alarmType"]').forEach(radio => {
      radio.addEventListener('change', function() {
        const type = this.value;
        document.getElementById('weeklyOptions').style.display = (type === 'weekly') ? 'block' : 'none';
        document.getElementById('onceOptions').style.display = (type === 'once') ? 'block' : 'none';
      });
    });
    
    /*******************
     * アラーム追加・スケジュール
     *******************/
    function addAlarm() {
      const timeInput = document.getElementById('alarmTime').value;
      const messageInput = document.getElementById('alarmMessage').value.trim();
      if (!timeInput) {
        alert("時刻を入力してください。");
        return;
      }
      if (!messageInput) {
        alert("メッセージを入力してください。");
        return;
      }
      const alarmType = document.querySelector('input[name="alarmType"]:checked').value;
      let alarm = {
        id: alarmIdCounter,
        mode: alarmType,
        time: timeInput,
        days: [],
        date: null,
        message: messageInput,
        enabled: true,
        active: false
      };
      if (alarmType === 'weekly') {
        const checkedDays = Array.from(document.querySelectorAll('#weeklyOptions input[type="checkbox"]:checked'))
                             .map(cb => parseInt(cb.value, 10));
        if (checkedDays.length === 0) {
          alert("曜日指定の場合、少なくとも1つの曜日を選択してください。");
          return;
        }
        alarm.days = checkedDays;
      } else if (alarmType === 'once') {
        const onceDate = document.getElementById('onceDate').value;
        if (!onceDate) {
          alert("一回限りの場合、日付を選択してください。");
          return;
        }
        alarm.date = onceDate;
      }
      alarms.push(alarm);
      alarmIdCounter++;
      if (alarm.enabled) { scheduleAlarm(alarm); }
      updateAlarmsTable();
      saveAlarms();
      alert("アラームを追加しました。");
    }
    
    function convertDaysToJapanese(days) {
      const dayNames = ["日", "月", "火", "水", "木", "金", "土"];
      return days.map(d => dayNames[d] || d).join("、");
    }
    
    function computeNextAlarmTime(alarm) {
      const now = new Date();
      const [hour, minute] = alarm.time.split(":").map(Number);
      let nextTime = null;
      if (alarm.mode === 'daily') {
        nextTime = new Date(now.getFullYear(), now.getMonth(), now.getDate(), hour, minute, 0);
        if (nextTime <= now) nextTime.setDate(nextTime.getDate() + 1);
      } else if (alarm.mode === 'weekly') {
        let daysAhead = null;
        for (let i = 0; i < 7; i++) {
          let potential = new Date(now);
          potential.setDate(now.getDate() + i);
          if (alarm.days.includes(potential.getDay())) {
            if (i === 0) {
              let currentMinutes = now.getHours() * 60 + now.getMinutes();
              let alarmMinutes = hour * 60 + minute;
              if (alarmMinutes > currentMinutes) { daysAhead = i; break; }
            } else { daysAhead = i; break; }
          }
        }
        if (daysAhead === null) daysAhead = 7;
        nextTime = new Date(now);
        nextTime.setDate(now.getDate() + daysAhead);
        nextTime.setHours(hour, minute, 0, 0);
      } else if (alarm.mode === 'once') {
        const [year, month, day] = alarm.date.split("-").map(Number);
        nextTime = new Date(year, month - 1, day, hour, minute, 0);
        if (nextTime <= now) return null;
      }
      return nextTime;
    }
    
    function scheduleAlarm(alarm) {
      if (!alarm.enabled) return;
      const nextTime = computeNextAlarmTime(alarm);
      if (!nextTime) return;
      alarm.nextTime = nextTime;
      const now = new Date();
      const timeout = nextTime.getTime() - now.getTime();
      alarm.timerId = setTimeout(() => {
        triggerAlarm(alarm.id);
        if (alarm.mode === 'daily' || alarm.mode === 'weekly') {
          scheduleAlarm(alarm);
          saveAlarms();
          updateAlarmsTable();
        } else if (alarm.mode === 'once') {
          removeAlarm(alarm.id);
          saveAlarms();
          updateAlarmsTable();
        }
      }, timeout);
    }
    
    function updateAlarmsTable() {
      const tbody = document.getElementById("alarmsTable").getElementsByTagName("tbody")[0];
      tbody.innerHTML = "";
      const sortedAlarms = alarms.slice().sort((a, b) => {
        const aTime = a.nextTime ? new Date(a.nextTime).getTime() : Infinity;
        const bTime = b.nextTime ? new Date(b.nextTime).getTime() : Infinity;
        return aTime - bTime;
      });
      sortedAlarms.forEach((alarm, index) => {
        const row = tbody.insertRow();
        row.className = alarm.active ? "active" : "upcoming";
        row.insertCell(0).innerText = index + 1;
        row.insertCell(1).innerText = alarm.time;
        row.insertCell(2).innerText = 
          alarm.mode === "daily" ? "毎日" :
          alarm.mode === "weekly" ? "曜日指定" : "一回限り";
        row.insertCell(3).innerText =
          alarm.mode === "weekly" ? convertDaysToJapanese(alarm.days) :
          (alarm.mode === "once" ? alarm.date : "-");
        row.insertCell(4).innerText = alarm.message;
        row.insertCell(5).innerText = alarm.nextTime ? alarm.nextTime.toLocaleString() : "-";
        const enableCell = row.insertCell(6);
        enableCell.innerHTML = `<input type="checkbox" id="toggle_${alarm.id}" onchange="toggleAlarmState(${alarm.id})" ${alarm.enabled ? "checked" : ""}>`;
        row.insertCell(7).innerHTML = `<button class="btn btn-danger" onclick="removeAlarm(${alarm.id})">削除</button>`;
      });
    }
    
    function toggleAlarmState(id) {
      const alarm = alarms.find(a => a.id === id);
      if (!alarm) return;
      const checkbox = document.getElementById("toggle_" + id);
      if (checkbox.checked) {
        alarm.enabled = true;
        scheduleAlarm(alarm);
      } else {
        alarm.enabled = false;
        if (alarm.timerId) {
          clearTimeout(alarm.timerId);
          alarm.timerId = null;
        }
      }
      saveAlarms();
      updateAlarmsTable();
    }
    
    function removeAlarm(id) {
      const idx = alarms.findIndex(a => a.id === id);
      if (idx !== -1) {
        if (alarms[idx].timerId) clearTimeout(alarms[idx].timerId);
        alarms.splice(idx, 1);
        updateAlarmsTable();
        saveAlarms();
      }
    }
    
    // 音声合成による繰り返し発話
    function repeatSpeakAlarm(message) {
      if (!isAlarmRinging) return;
      const utterance = new SpeechSynthesisUtterance(message);
      utterance.lang = "ja-JP";
      utterance.onend = function() {
        if (isAlarmRinging) { repeatSpeakAlarm(message); }
      };
      speechSynthesis.speak(utterance);
    }
    
    function triggerAlarm(id) {
      const alarm = alarms.find(a => a.id === id);
      if (!alarm || !alarm.enabled) return;
      if (!isAlarmRinging) {
        isAlarmRinging = true;
        document.getElementById("activeAlarmSection").style.display = "block";
        if ("Notification" in window && Notification.permission === "granted") {
          new Notification("アラーム発動", { body: alarm.message });
        }
        repeatSpeakAlarm(alarm.message);
      }
      alarm.active = true;
      updateAlarmsTable();
    }
    
    function stopAlarm() {
      if (isAlarmRinging) {
        isAlarmRinging = false;
        speechSynthesis.cancel();
        document.getElementById("activeAlarmSection").style.display = "none";
        alarms.forEach(a => { if (a.active) a.active = false; });
        updateAlarmsTable();
      }
    }
    
    window.addEventListener("load", () => { loadAlarms(); });
  </script>
</body>
</html>
