<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <!-- レスポンシブ対応のためのmetaタグ -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Multi Alarm App</title>
  <style>
    /* CSSリセットと基本設定 */
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    body {
      background-color: #1f1f1f;
      color: #e0e0e0;
      font-family: Arial, sans-serif;
      line-height: 1.6;
      padding: 1rem;
    }
    .container {
      max-width: 800px;
      margin: 0 auto;
      padding: 0 1rem;
    }
    header {
      text-align: center;
      margin-bottom: 1.5rem;
    }
    header h1 {
      font-size: 2.5rem;
      margin-bottom: 0.5rem;
    }
    /* カード風デザイン */
    .card {
      background-color: #2b2b2b;
      border-radius: 8px;
      padding: 1rem;
      margin-bottom: 1.5rem;
    }
    .card-header {
      font-size: 1.5rem;
      margin-bottom: 1rem;
      border-bottom: 1px solid #444;
      padding-bottom: 0.5rem;
    }
    .card-body {
      margin-bottom: 1rem;
    }
    /* フォームの設定 */
    .form-group {
      margin-bottom: 1rem;
    }
    label {
      display: block;
      margin-bottom: 0.3rem;
    }
    input[type="time"],
    input[type="date"],
    input[type="text"] {
      width: 100%;
      padding: 0.5rem;
      border: none;
      border-radius: 4px;
    }
    /* ラジオボタンとオプション群 */
    .radio-group, .option-inline {
      margin: 0.5rem 0;
    }
    .radio-group label,
    .option-inline label {
      margin-right: 1rem;
      cursor: pointer;
    }
    /* ボタン */
    .btn {
      background-color: #4CAF50;
      color: #fff;
      border: none;
      padding: 0.5rem 1rem;
      border-radius: 4px;
      cursor: pointer;
    }
    .btn:hover {
      background-color: #45a049;
    }
    .btn-danger {
      background-color: #e53935;
    }
    .btn-danger:hover {
      background-color: #d32f2f;
    }
    .btn-primary {
      background-color: #0d47a1;
    }
    .btn-primary:hover {
      background-color: #1565c0;
    }
    /* アラーム発動中の表示 */
    .active-alarm {
      background-color: #b71c1c;
      padding: 1rem;
      border-radius: 8px;
      text-align: center;
      margin-bottom: 1.5rem;
    }
    /* テーブルデザイン */
    table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 1.5rem;
    }
    table, th, td {
      border: 1px solid #444;
    }
    th, td {
      padding: 0.5rem;
      text-align: center;
    }
    th {
      background-color: #333;
    }
    tr.active {
      background-color: #b71c1c;
    }
    tr.upcoming:hover {
      background-color: #2a2a2a;
    }
    /* レスポンシブ対応（画面幅600px以下の場合） */
    @media (max-width: 600px) {
      header h1 {
        font-size: 2rem;
      }
      .card-header {
        font-size: 1.3rem;
      }
      th, td {
        font-size: 0.8rem;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- ヘッダー -->
    <header>
      <h1>Multi Alarm App</h1>
    </header>
    
    <!-- アラーム追加フォーム -->
    <section id="alarmForm" class="card">
      <div class="card-header">アラーム追加</div>
      <div class="card-body">
        <!-- 時刻入力 -->
        <div class="form-group">
          <label for="alarmTime">時刻入力</label>
          <input type="time" id="alarmTime">
        </div>
        <!-- メッセージ入力（必須） -->
        <div class="form-group">
          <label for="alarmMessage">メッセージ</label>
          <input type="text" id="alarmMessage" placeholder="例: 時間になりました。">
        </div>
        <!-- アラームタイプ選択 -->
        <div class="form-group radio-group">
          <label>アラームタイプ：</label>
          <label><input type="radio" name="alarmType" value="daily" checked> 毎日</label>
          <label><input type="radio" name="alarmType" value="weekly"> 曜日指定</label>
          <label><input type="radio" name="alarmType" value="once"> 一回限り</label>
        </div>
        <!-- 曜日指定オプション -->
        <div class="form-group" id="weeklyOptions" style="display:none;">
          <label>曜日を選択</label>
          <div class="option-inline">
            <label><input type="checkbox" value="0"> 日</label>
            <label><input type="checkbox" value="1"> 月</label>
            <label><input type="checkbox" value="2"> 火</label>
            <label><input type="checkbox" value="3"> 水</label>
            <label><input type="checkbox" value="4"> 木</label>
            <label><input type="checkbox" value="5"> 金</label>
            <label><input type="checkbox" value="6"> 土</label>
          </div>
        </div>
        <!-- 一回限りオプション -->
        <div class="form-group" id="onceOptions" style="display:none;">
          <label for="onceDate">日付選択</label>
          <input type="date" id="onceDate">
        </div>
        <!-- アラーム追加ボタン -->
        <button class="btn" id="addAlarmBtn" onclick="addAlarm()">アラーム追加</button>
      </div>
    </section>
    
    <!-- アラーム発動中表示 -->
    <section id="activeAlarmSection" class="active-alarm" style="display:none;">
      <p>アラーム発動中！</p>
      <button class="btn btn-primary" onclick="stopAlarm()">停止</button>
    </section>
    
    <!-- アラーム一覧 -->
    <section id="alarmList" class="card">
      <div class="card-header">設定済みアラーム一覧</div>
      <div class="card-body">
        <table id="alarmsTable">
          <thead>
            <tr>
              <th>#</th>
              <th>時刻</th>
              <th>タイプ</th>
              <th>詳細</th>
              <th>メッセージ</th>
              <th>次回実行</th>
              <th>有効</th>
              <th>操作</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>
  </div>
  
  <script>
    /*******************
     * グローバル変数
     *******************/
    let alarms = [];            // アラーム設定オブジェクトの配列
    let alarmIdCounter = 0;     // アラームIDのカウンター
    let isAlarmRinging = false; // アラーム発動中フラグ
    const STORAGE_KEY = 'alarms';

    // デスクトップ通知の許可をリクエスト
    if ("Notification" in window && Notification.permission !== "granted") {
      Notification.requestPermission();
    }

    /*******************
     * localStorageの読み込み
     *******************/
    function loadAlarms() {
      const data = localStorage.getItem(STORAGE_KEY);
      if (data) {
        try {
          const storedAlarms = JSON.parse(data);
          storedAlarms.forEach(alarmData => {
            const alarm = {
              id: alarmData.id,
              mode: alarmData.mode,
              time: alarmData.time,
              days: alarmData.days || [],
              date: alarmData.date || null,
              message: alarmData.message,
              enabled: alarmData.enabled,
              active: false
            };
            alarms.push(alarm);
            if (alarm.id >= alarmIdCounter) {
              alarmIdCounter = alarm.id + 1;
            }
            // スケジュール済みのアラームは再設定
            if (alarm.enabled) {
              scheduleAlarm(alarm);
            }
          });
          updateAlarmsTable();
        } catch (e) {
          console.error("読み込み失敗:", e);
        }
      }
    }
    
    /*******************
     * localStorageへ保存
     *******************/
    function saveAlarms() {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(alarms));
    }
    
    /*******************
     * ユーザー入力表示の制御
     *******************/
    // アラームタイプ選択時に追加オプションの表示を切り替える
    document.querySelectorAll('input[name="alarmType"]').forEach(radio => {
      radio.addEventListener('change', function() {
        const type = this.value;
        document.getElementById('weeklyOptions').style.display = (type === 'weekly') ? 'block' : 'none';
        document.getElementById('onceOptions').style.display = (type === 'once') ? 'block' : 'none';
      });
    });
    
    /*******************
     * アラーム追加処理
     *******************/
    function addAlarm() {
      const timeInput = document.getElementById('alarmTime').value;
      const messageInput = document.getElementById('alarmMessage').value.trim();
      if (!timeInput) {
        alert("時刻を入力してください。");
        return;
      }
      if (!messageInput) {
        alert("メッセージを入力してください。");
        return;
      }
      const alarmType = document.querySelector('input[name="alarmType"]:checked').value;
      let alarm = {
        id: alarmIdCounter,
        mode: alarmType,
        time: timeInput,
        days: [],
        date: null,
        message: messageInput,
        enabled: true,
        active: false
      };
      // 曜日指定の場合
      if (alarmType === 'weekly') {
        const checkedDays = Array.from(document.querySelectorAll('#weeklyOptions input[type="checkbox"]:checked'))
          .map(cb => parseInt(cb.value, 10));
        if (checkedDays.length === 0) {
          alert("曜日指定の場合、少なくとも1つの曜日を選択してください。");
          return;
        }
        alarm.days = checkedDays;
      }
      // 一回限りの場合
      if (alarmType === 'once') {
        const onceDate = document.getElementById('onceDate').value;
        if (!onceDate) {
          alert("一回限りの場合、日付を選択してください。");
          return;
        }
        alarm.date = onceDate;
      }
      alarms.push(alarm);
      alarmIdCounter++;
      // スケジュール登録と一覧更新
      if (alarm.enabled) {
        scheduleAlarm(alarm);
      }
      updateAlarmsTable();
      saveAlarms();
      alert("アラームを追加しました。");
    }
    
    /*******************
     * 曜日数値を日本語に変換
     *******************/
    function convertDaysToJapanese(days) {
      const dayNames = ["日", "月", "火", "水", "木", "金", "土"];
      return days.map(d => dayNames[d]).join("、");
    }
    
    /*******************
     * 次回実行時刻の計算
     *******************/
    function computeNextAlarmTime(alarm) {
      const now = new Date();
      const [hour, minute] = alarm.time.split(":").map(Number);
      let nextTime = null;
      if (alarm.mode === 'daily') {
        // 毎日の場合
        nextTime = new Date(now.getFullYear(), now.getMonth(), now.getDate(), hour, minute, 0);
        if (nextTime <= now) {
          nextTime.setDate(nextTime.getDate() + 1);
        }
      } else if (alarm.mode === 'weekly') {
        // 曜日指定の場合：次の対象曜日を探す
        let daysAhead = null;
        for (let i = 0; i < 7; i++) {
          let potential = new Date(now);
          potential.setDate(now.getDate() + i);
          if (alarm.days.includes(potential.getDay())) {
            if (i === 0) {
              let currentMinutes = now.getHours() * 60 + now.getMinutes();
              let alarmMinutes = hour * 60 + minute;
              if (alarmMinutes > currentMinutes) {
                daysAhead = i;
                break;
              }
            } else {
              daysAhead = i;
              break;
            }
          }
        }
        if (daysAhead === null) daysAhead = 7;
        nextTime = new Date(now);
        nextTime.setDate(now.getDate() + daysAhead);
        nextTime.setHours(hour, minute, 0, 0);
      } else if (alarm.mode === 'once') {
        // 一回限りの場合
        const [year, month, day] = alarm.date.split("-").map(Number);
        nextTime = new Date(year, month - 1, day, hour, minute, 0);
        if (nextTime <= now) return null;
      }
      return nextTime;
    }
    
    /*******************
     * アラームのスケジューリング
     *******************/
    function scheduleAlarm(alarm) {
      if (!alarm.enabled) return;
      const nextTime = computeNextAlarmTime(alarm);
      if (!nextTime) return;
      alarm.nextTime = nextTime;
      const now = new Date();
      const timeout = nextTime.getTime() - now.getTime();
      alarm.timerId = setTimeout(() => {
        triggerAlarm(alarm.id);
        // 毎日または曜日指定の場合は再スケジュール
        if (alarm.mode === 'daily' || alarm.mode === 'weekly') {
          scheduleAlarm(alarm);
          saveAlarms();
          updateAlarmsTable();
        } else if (alarm.mode === 'once') {
          removeAlarm(alarm.id);
          saveAlarms();
          updateAlarmsTable();
        }
      }, timeout);
    }
    
    /*******************
     * アラーム一覧の更新（テーブル表示）
     *******************/
    function updateAlarmsTable() {
      const tbody = document.getElementById("alarmsTable").getElementsByTagName("tbody")[0];
      tbody.innerHTML = "";
      // 次回実行時刻でソート（nextTimeが無い場合は後ろへ）
      const sortedAlarms = alarms.slice().sort((a, b) => {
        const aTime = a.nextTime ? new Date(a.nextTime).getTime() : Infinity;
        const bTime = b.nextTime ? new Date(b.nextTime).getTime() : Infinity;
        return aTime - bTime;
      });
      sortedAlarms.forEach((alarm, index) => {
        const row = tbody.insertRow();
        row.className = alarm.active ? "active" : "upcoming";
        row.insertCell(0).innerText = index + 1;
        row.insertCell(1).innerText = alarm.time;
        // タイプ表示
        let typeText = "";
        if (alarm.mode === "daily") { typeText = "毎日"; }
        else if (alarm.mode === "weekly") { typeText = "曜日指定"; }
        else if (alarm.mode === "once") { typeText = "一回限り"; }
        row.insertCell(2).innerText = typeText;
        // 詳細：曜日または日付
        let detail = "-";
        if (alarm.mode === "weekly") {
          detail = convertDaysToJapanese(alarm.days);
        } else if (alarm.mode === "once") {
          detail = alarm.date;
        }
        row.insertCell(3).innerText = detail;
        // メッセージ
        row.insertCell(4).innerText = alarm.message;
        // 次回実行
        row.insertCell(5).innerText = alarm.nextTime ? alarm.nextTime.toLocaleString() : "-";
        // 有効／無効切替（チェックボックス）
        const enableCell = row.insertCell(6);
        enableCell.innerHTML = `<input type="checkbox" id="toggle_${alarm.id}" onchange="toggleAlarmState(${alarm.id})" ${alarm.enabled ? "checked" : ""}>`;
        // 操作（削除ボタン）
        row.insertCell(7).innerHTML = `<button class="btn btn-danger" onclick="removeAlarm(${alarm.id})">削除</button>`;
      });
    }
    
    /*******************
     * 有効／無効の切替処理
     *******************/
    function toggleAlarmState(id) {
      const alarm = alarms.find(a => a.id === id);
      if (!alarm) return;
      const checkbox = document.getElementById("toggle_" + id);
      if (checkbox.checked) {
        alarm.enabled = true;
        scheduleAlarm(alarm);
      } else {
        alarm.enabled = false;
        if (alarm.timerId) {
          clearTimeout(alarm.timerId);
          alarm.timerId = null;
        }
      }
      saveAlarms();
      updateAlarmsTable();
    }
    
    /*******************
     * アラーム削除処理
     *******************/
    function removeAlarm(id) {
      const idx = alarms.findIndex(a => a.id === id);
      if (idx !== -1) {
        if (alarms[idx].timerId) clearTimeout(alarms[idx].timerId);
        alarms.splice(idx, 1);
        updateAlarmsTable();
        saveAlarms();
      }
    }
    
    /*******************
     * SpeechSynthesisを使った音声の繰り返し読み上げ
     *******************/
    function repeatSpeakAlarm(message) {
      if (!isAlarmRinging) return;
      let utterance = new SpeechSynthesisUtterance(message);
      utterance.lang = "ja-JP";
      utterance.onend = function() {
        if (isAlarmRinging) {
          repeatSpeakAlarm(message);
        }
      };
      speechSynthesis.speak(utterance);
    }
    
    /*******************
     * アラーム発動処理（通知＋音声合成）
     *******************/
    function triggerAlarm(id) {
      const alarm = alarms.find(a => a.id === id);
      if (!alarm || !alarm.enabled) return;
      // 発動中でなければ
      if (!isAlarmRinging) {
        isAlarmRinging = true;
        document.getElementById("activeAlarmSection").style.display = "block";
        // デスクトップ通知
        if ("Notification" in window && Notification.permission === "granted") {
          new Notification("アラーム発動", { body: alarm.message });
        }
        // 音声合成でメッセージを繰り返し読み上げ
        repeatSpeakAlarm(alarm.message);
      }
      alarm.active = true;
      updateAlarmsTable();
    }
    
    /*******************
     * アラーム停止処理
     *******************/
    function stopAlarm() {
      if (isAlarmRinging) {
        isAlarmRinging = false;
        speechSynthesis.cancel();  // 現在の読み上げを停止
        document.getElementById("activeAlarmSection").style.display = "none";
        alarms.forEach(a => { if (a.active) a.active = false; });
        updateAlarmsTable();
      }
    }
    
    /*******************
     * 初回読み込み時の処理
     *******************/
    window.addEventListener("load", () => {
      loadAlarms();
    });
  </script>
</body>
</html>
