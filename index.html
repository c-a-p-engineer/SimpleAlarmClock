<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>マルチアラーム - 有効/無効切替＆音声合成対応</title>
  <style>
    /* ダークテーマ・モダンなクールデザイン */
    body {
      background: #1f1f1f;
      color: #e0e0e0;
      font-family: 'Roboto', sans-serif;
      margin: 0;
      padding: 0;
    }
    header {
      text-align: center;
      padding: 2rem 1rem;
      background: #333;
      box-shadow: 0 2px 4px rgba(0,0,0,0.5);
    }
    h1 {
      margin: 0;
      font-size: 2.5rem;
    }
    section {
      padding: 1rem 2rem;
    }
    /* 設定入力エリア */
    .config {
      background: #2b2b2b;
      border-radius: 4px;
      padding: 1rem 1.5rem;
      margin: 1rem auto 2rem;
      max-width: 600px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.3);
    }
    .config label {
      font-size: 1.1rem;
      margin-right: 0.5rem;
    }
    .config input[type="time"],
    .config input[type="date"],
    .config input[type="text"] {
      font-size: 1rem;
      padding: 0.3rem;
      border: none;
      border-radius: 4px;
      margin-right: 1rem;
    }
    .config fieldset {
      border: none;
      margin: 0.5rem 0;
      padding: 0;
    }
    .config fieldset legend {
      font-size: 1.1rem;
      margin-bottom: 0.3rem;
    }
    .config input[type="radio"] {
      margin-right: 0.3rem;
    }
    .config .option-group {
      margin: 0.5rem 0;
    }
    .config button {
      font-size: 1.1rem;
      padding: 0.5rem 1rem;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      background-color: #4CAF50;
      color: #fff;
      transition: background-color 0.3s;
    }
    .config button:hover {
      background-color: #45a049;
    }
    /* アラーム一覧テーブル */
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 1rem;
    }
    th, td {
      padding: 0.75rem;
      text-align: center;
      border-bottom: 1px solid #444;
    }
    th {
      background: #333;
    }
    tr.upcoming:hover {
      background-color: #2a2a2a;
    }
    tr.active {
      background-color: #b71c1c;
    }
    button.delete {
      background-color: #e53935;
      border: none;
      border-radius: 4px;
      color: #fff;
      padding: 0.4rem 0.8rem;
      cursor: pointer;
      transition: background-color 0.3s;
    }
    button.delete:hover {
      background-color: #d32f2f;
    }
    /* アクティブアラーム表示 */
    .active-alarm {
      text-align: center;
      padding: 1rem;
      background: #b71c1c;
      border-radius: 4px;
      margin: 2rem auto;
      max-width: 400px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.5);
    }
    .active-alarm button {
      background-color: #0d47a1;
      border: none;
      border-radius: 4px;
      color: #fff;
      padding: 0.5rem 1rem;
      cursor: pointer;
      transition: background-color 0.3s;
    }
    .active-alarm button:hover {
      background-color: #1565c0;
    }
  </style>
</head>
<body>
  <header>
    <h1>マルチアラーム</h1>
  </header>
  
  <!-- アラーム設定入力エリア -->
  <section class="config">
    <div>
      <label for="alarmTime">時刻入力:</label>
      <input type="time" id="alarmTime">
    </div>
    <!-- メッセージ入力フィールドを追加 -->
    <div>
      <label for="alarmMessage">メッセージ:</label>
      <input type="text" id="alarmMessage" placeholder="例: 時間になりました。">
    </div>
    <fieldset>
      <legend>アラームタイプ</legend>
      <label><input type="radio" name="alarmType" value="daily" checked> 毎日</label>
      <label><input type="radio" name="alarmType" value="weekly"> 曜日指定</label>
      <label><input type="radio" name="alarmType" value="once"> 一回限り</label>
    </fieldset>
    <div class="option-group" id="weeklyOptions" style="display:none;">
      <label><input type="checkbox" value="0"> 日</label>
      <label><input type="checkbox" value="1"> 月</label>
      <label><input type="checkbox" value="2"> 火</label>
      <label><input type="checkbox" value="3"> 水</label>
      <label><input type="checkbox" value="4"> 木</label>
      <label><input type="checkbox" value="5"> 金</label>
      <label><input type="checkbox" value="6"> 土</label>
    </div>
    <div class="option-group" id="onceOptions" style="display:none;">
      <label for="onceDate">日付選択:</label>
      <input type="date" id="onceDate">
    </div>
    <button onclick="addAlarm()">アラーム追加</button>
  </section>
  
  <!-- 設定済みアラーム一覧 -->
  <section class="alarms">
    <h2 style="text-align:center;">設定済みアラーム一覧</h2>
    <table id="alarmsTable">
      <thead>
        <tr>
          <th>#</th>
          <th>時刻</th>
          <th>タイプ</th>
          <th>詳細</th>
          <th>メッセージ</th>
          <th>次回実行</th>
          <th>有効</th>
          <th>操作</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </section>
  
  <!-- アラーム発動時表示 -->
  <section class="active-alarm" id="activeAlarmSection" style="display:none;">
    <h2>アクティブアラーム</h2>
    <p>アラーム発動中！</p>
    <button onclick="stopAlarm()">停止</button>
  </section>
  
  <script>
    /*******************
     * グローバル変数
     *******************/
    let alarms = [];            // アラーム設定リスト
    let alarmIdCounter = 0;     
    let isAlarmRinging = false; // 現在アラームが鳴っているか
    
    const STORAGE_KEY = 'alarms';
    
    /*******************
     * localStorage 保存／読み込み
     *******************/
    function saveAlarms() {
      const alarmsToSave = alarms.map(alarm => {
        return {
          id: alarm.id,
          mode: alarm.mode,
          time: alarm.time,
          days: alarm.days,
          date: alarm.date,
          message: alarm.message,
          enabled: alarm.enabled
        };
      });
      localStorage.setItem(STORAGE_KEY, JSON.stringify(alarmsToSave));
    }
    function loadAlarms() {
      const data = localStorage.getItem(STORAGE_KEY);
      if (data) {
        try {
          const storedAlarms = JSON.parse(data);
          storedAlarms.forEach(alarmData => {
            const alarm = {
              id: alarmData.id,
              mode: alarmData.mode,
              time: alarmData.time,
              days: alarmData.days || [],
              date: alarmData.date || null,
              message: alarmData.message,
              enabled: alarmData.enabled,
              active: false
            };
            alarms.push(alarm);
            if (alarm.id >= alarmIdCounter) {
              alarmIdCounter = alarm.id + 1;
            }
            if (alarm.enabled) {
              scheduleAlarm(alarm);
            }
          });
          updateAlarmsTable();
        } catch(e) {
          console.error("保存データの読み込みに失敗:", e);
        }
      }
    }
    
    /*******************
     * ユーザー入力表示の制御
     *******************/
    document.querySelectorAll('input[name="alarmType"]').forEach(radio => {
      radio.addEventListener('change', function() {
        const type = this.value;
        document.getElementById('weeklyOptions').style.display = (type === 'weekly') ? 'block' : 'none';
        document.getElementById('onceOptions').style.display = (type === 'once') ? 'block' : 'none';
      });
    });
    
    /*******************
     * アラーム追加・スケジュール
     *******************/
    function addAlarm() {
      const timeInput = document.getElementById('alarmTime').value;
      const messageInput = document.getElementById('alarmMessage').value.trim();
      if (!timeInput) {
        alert("時刻を入力してください。");
        return;
      }
      if (!messageInput) {
        alert("メッセージを入力してください。");
        return;
      }
      const alarmType = document.querySelector('input[name="alarmType"]:checked').value;
      let alarm = {
        id: alarmIdCounter,
        mode: alarmType,
        time: timeInput,
        days: [],
        date: null,
        message: messageInput,
        enabled: true,  // デフォルトは有効
        active: false
      };
      
      if (alarmType === 'weekly') {
        const checkedDays = Array.from(document.querySelectorAll('#weeklyOptions input[type="checkbox"]:checked'))
                          .map(cb => parseInt(cb.value, 10));
        if (checkedDays.length === 0) {
          alert("曜日指定の場合、少なくとも1つの曜日を選択してください。");
          return;
        }
        alarm.days = checkedDays;
      } else if (alarmType === 'once') {
        const onceDate = document.getElementById('onceDate').value;
        if (!onceDate) {
          alert("一回限りの場合、日付を選択してください。");
          return;
        }
        alarm.date = onceDate;
      }
      alarms.push(alarm);
      alarmIdCounter++;
      if(alarm.enabled) scheduleAlarm(alarm);
      updateAlarmsTable();
      saveAlarms();
      alert("アラームを追加しました。");
    }
    
    /**
     * 曜日数値（0～6）を日本語の曜日に変換する
     */
    function convertDaysToJapanese(days) {
      const dayNames = ["日", "月", "火", "水", "木", "金", "土"];
      return days.map(d => dayNames[d] || d).join("、");
    }
    
    /**
     * 次回実行時刻を計算
     */
    function computeNextAlarmTime(alarm) {
      const now = new Date();
      const [hour, minute] = alarm.time.split(":").map(Number);
      let nextTime = null;
      if (alarm.mode === 'daily') {
        nextTime = new Date(now.getFullYear(), now.getMonth(), now.getDate(), hour, minute, 0);
        if (nextTime <= now) nextTime.setDate(nextTime.getDate() + 1);
      } else if (alarm.mode === 'weekly') {
        let daysAhead = null;
        for (let i = 0; i < 7; i++) {
          let potential = new Date(now);
          potential.setDate(now.getDate() + i);
          if (alarm.days.includes(potential.getDay())) {
            if (i === 0) {
              let currentMinutes = now.getHours() * 60 + now.getMinutes();
              let alarmMinutes = hour * 60 + minute;
              if (alarmMinutes > currentMinutes) {
                daysAhead = i;
                break;
              }
            } else {
              daysAhead = i;
              break;
            }
          }
        }
        if (daysAhead === null) daysAhead = 7;
        nextTime = new Date(now);
        nextTime.setDate(now.getDate() + daysAhead);
        nextTime.setHours(hour, minute, 0, 0);
      } else if (alarm.mode === 'once') {
        const [year, month, day] = alarm.date.split("-").map(Number);
        nextTime = new Date(year, month - 1, day, hour, minute, 0);
        if (nextTime <= now) return null;
      }
      return nextTime;
    }
    
    /**
     * 指定アラームのタイマーをスケジュール
     */
    function scheduleAlarm(alarm) {
      if (!alarm.enabled) return;
      const nextTime = computeNextAlarmTime(alarm);
      if (!nextTime) return;
      alarm.nextTime = nextTime;
      const now = new Date();
      const timeout = nextTime.getTime() - now.getTime();
      alarm.timerId = setTimeout(() => {
        triggerAlarm(alarm.id);
        if (alarm.mode === 'daily' || alarm.mode === 'weekly') {
          scheduleAlarm(alarm);
          saveAlarms();
          updateAlarmsTable();
        } else if (alarm.mode === 'once') {
          removeAlarm(alarm.id);
          saveAlarms();
          updateAlarmsTable();
        }
      }, timeout);
    }
    
    /*******************
     * アラーム一覧表示・削除・切替
     *******************/
    function updateAlarmsTable() {
      const tbody = document.getElementById("alarmsTable").getElementsByTagName("tbody")[0];
      tbody.innerHTML = "";
      // 次回実行時刻順にソート（nextTime がないものは後ろへ）
      const sortedAlarms = alarms.slice().sort((a, b) => {
        const aTime = a.nextTime ? new Date(a.nextTime).getTime() : Infinity;
        const bTime = b.nextTime ? new Date(b.nextTime).getTime() : Infinity;
        return aTime - bTime;
      });
      sortedAlarms.forEach((alarm, index) => {
        const row = tbody.insertRow();
        row.className = alarm.active ? "active" : "upcoming";
        row.insertCell(0).innerText = index + 1;
        row.insertCell(1).innerText = alarm.time;
        row.insertCell(2).innerText = 
          alarm.mode === "daily" ? "毎日" :
          alarm.mode === "weekly" ? "曜日指定" : "一回限り";
        row.insertCell(3).innerText = 
          alarm.mode === "weekly" ? convertDaysToJapanese(alarm.days) :
          (alarm.mode === "once" ? alarm.date : "-");
        // 新規：メッセージ列
        row.insertCell(4).innerText = alarm.message;
        row.insertCell(5).innerText = alarm.nextTime ? alarm.nextTime.toLocaleString() : "-";
        // 有効／無効切替（チェックボックス）
        const enableCell = row.insertCell(6);
        enableCell.innerHTML = `<input type="checkbox" id="toggle_${alarm.id}" onchange="toggleAlarmState(${alarm.id})" ${alarm.enabled ? "checked" : ""}>`;
        row.insertCell(7).innerHTML = `<button class="delete" onclick="removeAlarm(${alarm.id})">削除</button>`;
      });
    }
    
    function toggleAlarmState(id) {
      const alarm = alarms.find(a => a.id === id);
      if (!alarm) return;
      const checkbox = document.getElementById("toggle_" + id);
      if (checkbox.checked) {
        // 再有効化：スケジュール再登録
        alarm.enabled = true;
        scheduleAlarm(alarm);
      } else {
        // 無効化：タイマーキャンセル
        alarm.enabled = false;
        if (alarm.timerId) {
          clearTimeout(alarm.timerId);
          alarm.timerId = null;
        }
      }
      saveAlarms();
      updateAlarmsTable();
    }
    
    function removeAlarm(id) {
      const idx = alarms.findIndex(a => a.id === id);
      if (idx !== -1) {
        if(alarms[idx].timerId) clearTimeout(alarms[idx].timerId);
        alarms.splice(idx, 1);
        updateAlarmsTable();
        saveAlarms();
      }
    }
    
    /*******************
     * 音声再生（SpeechSynthesis）によるアラーム発動処理
     *******************/
    function speakAlarmMessage(message) {
      const utterance = new SpeechSynthesisUtterance(message);
      utterance.lang = "ja-JP";
      speechSynthesis.speak(utterance);
    }
    
    function triggerAlarm(id) {
      // 有効なアラームのみ実行
      const alarm = alarms.find(a => a.id === id);
      if (!alarm || !alarm.enabled) return;
      if (!isAlarmRinging) {
        isAlarmRinging = true;
        document.getElementById("activeAlarmSection").style.display = "block";
        // 設定されたメッセージで音声合成を実行
        speakAlarmMessage(alarm.message);
      }
      alarm.active = true;
      updateAlarmsTable();
    }
    
    function stopAlarm() {
      if (isAlarmRinging) {
        // speechSynthesis の停止 API はないため、次の発話まで待機
        isAlarmRinging = false;
        document.getElementById("activeAlarmSection").style.display = "none";
        alarms.forEach(a => { if(a.active) a.active = false; });
        updateAlarmsTable();
      }
    }
    
    /*******************
     * 初回読み込み時処理
     *******************/
    window.addEventListener("load", () => {
      loadAlarms();
    });
  </script>
</body>
</html>
